server {
     {
        % for port in server.listening_ports
    }
    listen {
         {
            port.port
        }
        } {
            % if port.port == 443
        }
        ssl {
            % endif
        }
        ;
         {
            % endfor
        }
         {
            % if port.port == 443
        }
        ssl {
            % endif
        }
        ;

         {
            % for domain in domains
        }
        server_name {
             {
                domain.domain
            }
            };
             {
                % endfor
            }
            ;

            # SSL Configuration
             {
                % if certificates
            }
            ssl_certificate /etc/nginx/certificates/ {
                 {
                    certificates[0].name
                }
                }.crt;
                ssl_certificate_key /etc/nginx/certificates/ {
                     {
                        certificates[0].name
                    }
                    }.key;
                    .crt;
                    .key;
                    ssl_protocols TLSv1.2 TLSv1.3;
                    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
                    ssl_prefer_server_ciphers off;
                    ssl_session_cache shared:SSL:10m;
                    ssl_session_timeout 10m;
                     {
                        % endif
                    }

                    # Logging
                    access_log {
                         {
                            server.accessLogPath
                        }
                        };
                        error_log {
                             {
                                server.errorLogPath
                            }
                            } {
                                 {
                                    server.logLevel
                                }
                                };
                                ;
                                ;
                                 {
                                     {
                                        server.logLevel
                                    }
                                    };

                                    ;
                                    # Client settings
                                    client_max_body_size 10M;
                                    client_body_timeout 60s;
                                    client_header_timeout 60s;

                                    # Security headers
                                    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
                                    add_header X-Frame-Options DENY;
                                    add_header X-Content-Type-Options nosniff;
                                    add_header X-XSS-Protection "1; mode=block";

                                    # Rate limiting
                                    limit_req zone=api burst=20 nodelay;

                                     {
                                        % for location in locations
                                    }
                                    location {
                                         {
                                            location.path
                                        }
                                        } {
                                            proxy_pass http:// {
                                                 {
                                                    location.upstream.name
                                                }
                                                }; {
                                                    ;
                                                    proxy_set_header Host $host;
                                                    proxy_set_header X-Real-IP $remote_addr;
                                                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                                                    proxy_set_header X-Forwarded-Proto $scheme;

                                                    proxy_connect_timeout 60s;
                                                    proxy_send_timeout 60s;
                                                    proxy_read_timeout 60s;

                                                     {
                                                        % if location.clientMaxBodySize
                                                    }
                                                    client_max_body_size {
                                                         {
                                                            location.clientMaxBodySize
                                                        }
                                                        };
                                                         {
                                                            % endif
                                                        }
                                                        ;

                                                         {
                                                            % if location.additionalConfig
                                                        }
                                                         {
                                                             {
                                                                location.additionalConfig
                                                            }
                                                        }
                                                         {
                                                            % endif
                                                        }

                                                         {
                                                            % for rule in location.access_rules
                                                        }
                                                         {
                                                            % if rule.action == "allow"
                                                        }
                                                        allow {
                                                             {
                                                                rule.ipAddress
                                                            }
                                                            };
                                                             {
                                                                % else
                                                            }
                                                            ;
                                                            deny {
                                                                 {
                                                                    rule.ipAddress
                                                                }
                                                                };
                                                                 {
                                                                    % endif
                                                                }
                                                                ;
                                                                 {
                                                                    % endfor
                                                                }
                                                            }
                                                             {
                                                                % endfor
                                                            }

                                                             {
                                                                % if server.additionalConfig
                                                            }
                                                             {
                                                                 {
                                                                    server.additionalConfig
                                                                }
                                                            }
                                                             {
                                                                % endif
                                                            }
                                                        }
                                                        } {
                                                             {
                                                                { {
                                                                    server.additionalConfig
                                                                }
                                                                } {
                                                                    % endif {
                                                                        {
                                                                        }
                                                                    }